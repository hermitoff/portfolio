<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Gestion des pages – Admin</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' href='/main.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
    </div>
    <%- include('../../partials/navbar') %>
    
    <div class="cv-layout" style="max-width: 1400px; margin: 80px auto;">
        <div class="cv-left" style="width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h1><i class="fas fa-file-alt" style="margin-right: 10px;"></i>Gestion des pages</h1>
                    <p style="color: #666; margin: 0;">Gérer toutes les pages de votre portfolio</p>
                </div>
                <button onclick="createNewPage()" style="background: #16a34a;">
                    <i class="fas fa-plus" style="margin-right: 8px;"></i>
                    Nouvelle page
                </button>
            </div>
            
            <!-- Tableau des pages -->
            <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); overflow: hidden;">
                <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <input type="text" id="searchInput" placeholder="Rechercher une page..." style="flex: 1; padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem;">
                        <select id="statusFilter" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white;">
                            <option value="">Tous les statuts</option>
                            <option value="published">Publié</option>
                            <option value="draft">Brouillon</option>
                        </select>
                        <button onclick="refreshPages()" style="padding: 10px 15px; background: #6366f1;">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div id="pagesTable">
                    <!-- Le contenu sera chargé ici -->
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Chargement des pages...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <%- include('../../partials/footer') %>
    <script src="/index.js"></script>
    <script>
        let pages = [];
        
        // Charger les pages au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            loadPages();
            
            // Recherche en temps réel
            document.getElementById('searchInput').addEventListener('input', filterPages);
            document.getElementById('statusFilter').addEventListener('change', filterPages);
        });
        
        async function loadPages() {
            try {
                const response = await fetch('/api/admin/pages');
                if (response.ok) {
                    pages = await response.json();
                    renderPages(pages);
                } else {
                    showError('Erreur lors du chargement des pages');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }
        
        function renderPages(pagesToRender) {
            const container = document.getElementById('pagesTable');
            
            if (pagesToRender.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-file-plus" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Aucune page trouvée</p>
                        <button onclick="createNewPage()" style="margin-top: 15px; background: #16a34a;">
                            <i class="fas fa-plus" style="margin-right: 8px;"></i>
                            Créer la première page
                        </button>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f9fafb;">
                        <tr>
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Titre</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">ID</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Statut</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Navigation</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Dernière MAJ</th>
                            <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pagesToRender.map(page => `
                            <tr style="border-bottom: 1px solid #e5e7eb;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                                <td style="padding: 15px;">
                                    <div>
                                        <div style="font-weight: 500; color: #111827;">${page.title}</div>
                                        <div style="font-size: 0.85rem; color: #6b7280; margin-top: 2px;">${page.description || 'Aucune description'}</div>
                                    </div>
                                </td>
                                <td style="padding: 15px;">
                                    <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">${page.id}</code>
                                </td>
                                <td style="padding: 15px; text-align: center;">
                                    <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; ${page.published ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;'}">
                                        ${page.published ? 'Publié' : 'Brouillon'}
                                    </span>
                                </td>
                                <td style="padding: 15px; text-align: center;">
                                    <i class="fas fa-${page.visibleInNav ? 'eye' : 'eye-slash'}" style="color: ${page.visibleInNav ? '#059669' : '#6b7280'};"></i>
                                </td>
                                <td style="padding: 15px; text-align: center; font-size: 0.85rem; color: #6b7280;">
                                    ${formatDate(page.updatedAt)}
                                </td>
                                <td style="padding: 15px; text-align: center;">
                                    <div style="display: flex; gap: 8px; justify-content: center;">
                                        <button onclick="editPage('${page.id}')" title="Modifier" style="padding: 6px 10px; background: #3b82f6; font-size: 0.85rem;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="viewPage('${page.id}')" title="Voir" style="padding: 6px 10px; background: #10b981; font-size: 0.85rem;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="deletePage('${page.id}')" title="Supprimer" style="padding: 6px 10px; background: #ef4444; font-size: 0.85rem;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }
        
        function filterPages() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = pages.filter(page => {
                const matchesSearch = page.title.toLowerCase().includes(searchTerm) || 
                                    page.id.toLowerCase().includes(searchTerm) ||
                                    (page.description && page.description.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || 
                                    (statusFilter === 'published' && page.published) ||
                                    (statusFilter === 'draft' && !page.published);
                
                return matchesSearch && matchesStatus;
            });
            
            renderPages(filtered);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Aujourd\'hui';
            if (days === 1) return 'Hier';
            if (days < 7) return `Il y a ${days} jours`;
            
            return date.toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'short', 
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined 
            });
        }
        
        function createNewPage() {
            window.location.href = '/admin/pages/edit';
        }
        
        function editPage(pageId) {
            window.location.href = `/admin/pages/edit/${pageId}`;
        }
        
        function viewPage(pageId) {
            window.open(`/${pageId}`, '_blank');
        }
        
        async function deletePage(pageId) {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer la page "${pageId}" ? Cette action est irréversible.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/pages/${pageId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showSuccess('Page supprimée avec succès');
                    loadPages(); // Recharger la liste
                } else {
                    const error = await response.json();
                    showError(error.message || 'Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }
        
        function refreshPages() {
            loadPages();
        }
        
        function showError(message) {
            // Vous pouvez implémenter un système de notification ici
            alert('Erreur: ' + message);
        }
        
        function showSuccess(message) {
            // Vous pouvez implémenter un système de notification ici
            alert('Succès: ' + message);
        }
    </script>
</body>
</html>
